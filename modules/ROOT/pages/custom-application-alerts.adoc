= Custom Application Alerts and Notifications
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:keywords: cloudhub, monitoring, api, runtime manager, arm


image:logo-cloud-active.png[link="/runtime-manager/deployment-strategies#cloudhub", title="CloudHub"]
image:logo-hybrid-disabled.png[link="/runtime-manager/deployment-strategies#hybrid", title="Hybrid"]
image:logo-server-disabled.png[link="/runtime-manager/deployment-strategies#anypoint-platform-private-cloud-edition", title="Anypoint Platform PCE"]
image:logo-rtf-disabled.png[link="/runtime-manager/deployment-strategies#anypoint-runtime-fabric", title="Runtime Fabric"]

== Prerequisites

* Deploy your application to CloudHub.
+
See xref:deploying-to-cloudhub.adoc[Deploy to CloudHub]
* For Anypoint Studio 6.x and earlier, enable Maven support for your Mule project.
+
See xref:6@studio::enabling-maven-support-for-a-studio-project.adoc[Enabling Maven Support for a Studio Project].
+
All projects in Studio 7.x and later are mavenized by default.


== How to Use Notifications

Notifications give you visibility into business-related events inside your application. For example, you can create notifications for when:

* Your application is unable to connect to a remote service.
* An error that requires human intervention occurs, such as a problem with data mapping.
* You want to create a summary of what occurred inside your application, such as the number of orders processed.

In combination with xref:alerts-on-runtime-manager.adoc[alerts], you can direct these notifications to different people to act on the alerts and fix the underlying problems.

This example illustrates:

* How to send business related events as notifications
* How to send errors as notifications
* How to send email alerts when notifications arrive

[NOTE]
CloudHub stores up to a maximum of 1000 notifications per application.
If the number of notifications exceeds the maximum,
CloudHub deletes the oldest notification.
Each notification can contain up to 10,000 characters.

== Deploy Your Application

To deploy your application, in the Runtime Manager click *Deploy Application* from the *Applications* menu. For more information, see xref:deploying-to-cloudhub.adoc[Deploy to CloudHub].

== Trigger Your Notification

Once your application is running, you can trigger the notification by going to your application's URL, for example: `+http://YOURAPP.cloudhub.io/hello-notification+`. The page displays a `Hello World` message, and automatically creates a new notification in your Runtime Manager console. 

Return to the Runtime Manager console and click the new notification indicator bell in the upper-right to display the alert message:

image::image2014-10-24-17-41-16-1.png[image2014-10-24+17-41-16-1]

If the notification is sent after an exception, it attaches the
`exception.message` and `exception.stacktrace` as custom properties of the notification, which are accessible from the Runtime Manager console.

== Custom Alerts

Alerts enable you to send email based on your application's notifications. You can create standard alerts in CloudHub from Runtime Manager.

To create custom alerts, you must add Anypoint Connector for CloudHub (CloudHub Connector) to flows in your Mule application using Anypoint Studio.
CloudHub Connector is available for both Mule 3 and Mule 4 applications.

[NOTE]
Custom alerts and notifications are available only for applications deployed to CloudHub workers. They are not available for applications that you deploy to on-premises servers. See xref:deployment-strategies.adoc[Deployment Options] for more details.

=== Create a Custom Alert

To create a custom alert in Anypoint Studio:

. In Studio, add and configure CloudHub Connector in your Mule project:
+
--
.. In the Mule Palette view, click *CloudHub* and then drag the *Create Notification* operation to the application flow for which you want to trigger an alert in the canvas.
.. In the canvas, click *Create Notification*.
.. In the *Create Notificaton* properties window, click the green plus icon (*+*) to the right of the *Connector configuration* field.
.. In the *Global Element Properties* window, configure authentication to Anypoint Platform and click *OK*:
+
.The arrow shows the *Username* field in the *Global Element Properties* window.
image::alerts-custom-ch-connector.png[Username field in the Global Element Properties window]
+
The connector can use basic authentication or inherited token authentication.
.. In the *Create Notificaton* properties window, under *General*, create the notification. 
For information, see 
xref:connectors::cloudhub-connector/1.0/#creating-notifications[Creating a Notification].
--
. Deploy the app to CloudHub.
. In Runtime Manager, bind the custom notification to an alert:
+
--
.. Click *Alerts* in the menu on the left. 
.. Click the blue plus icon (*+*) to create a new alert.
.. In the *Create an Alert* page, configure your custom alert and click *Submit*:
+
--
.The arrow shows the *Applications* field in the *Create an Alert* window.
image::alerts-custom-rtm-create.png[Applications field in the Create an Alert window]

Name::
Enter a meaningful name for the custom alert. 
Severity level::
Select the severity level to apply to the alert:
* *Critical*
* *Warning*
* *Info*
Source::
Select *Applications* for the alert source.
Application type::
Select *CloudHub Applications*.
Applications::
Select the application that contains the flow that you configured to trigger a custom alert.
Condition::
Select *Custom application notification*.
** Select the *Priority* from the drop-down list, or leave the priority as *Any* to send notifications regardless of priority.
** In *Contains*, enter the string to use to trigger a notification.
+
This string must match a string in the *Message* field that you configured in CloudHub Connector.
Subject::
Enter the subject line to include in the notification email. 
Message::
Enter the custom message to include in the notification. 
Recipients::
Enter the email addresses for notification recipients. 
--
--

To trigger your notification, open your application URL, for example: `+http://YOURAPP.cloudhub.io/+`.
The addresses you specified receive an email with your notification.

This is an example of custom properties defining where to send a notification.

[source,xml,linenums]
----
<cloudhub:create-notification message="Error processing transaction." priority="ERROR">
  <cloudhub:custom-properties >
    <cloudhub:custom-property key="originalPayload">#[flowVars.originalPayload]</cloudhub:custom-property>
  </cloudhub:custom-properties>
</cloudhub:create-notification>
----

Then, they can be accessed as normal properties in the message, for example `${originalPayload}`.

== Send an Error Notification

You can use the CloudHub Connector inside a catch exception strategy to send notifications when errors happen. 

To do this:

. Add the following XML to your `mule-config.xml`:
+
[source,xml,linenums]
----
<flow name="create notification from exception">
    <inbound-endpoint address="http://0.0.0.0:${http.port}/create-notification-from-exception"/>
    <scripting:component>
        <scripting:script engine="groovy">
            throw new Exception("Could not connect to remote service.")
        </scripting:script>
    </scripting:component>
    <default-exception-strategy>
        <cloudhub:create-notification message="Error processing transaction." priority="ERROR"/>
    </default-exception-strategy>
</flow>
----
+
This flow throws an exception and creates a notification from that exception with the message `Error processing transaction`. The exception stack trace for the flow is attached to the message. This can optionally be turned off using the `attachStacktrace` attribute.
. Build and deploy your application, then go to the URL: `+http://YOURAPP.cloudhub.io/create-notification-from-exception+`. 
. Return to the Runtime Manager console, where a notification pop-up appears in the top-right. 
. Click the notifications link, and the notification with the stack trace appears in the notifications list.
+
image::notifications-exception.png[notifications_exception]
+
. To view the whole stack trace and details, click *More...* and the whole message appears in a pop-up window:
+
image::notifications-stack-trace.png[notifications_stack_trace]

== See Also

* xref:connectors::introduction:intro-config-use-studio.adoc#install[Add the Connector to Your Mule Project]
* https://www.mulesoft.com/exchange/#!/cloudhub-integration-connector[CloudHub Connector] on Exchange
* xref:cloudhub-connector/1.0/#create-the-cloudhub-configuration[Create the CloudHub Configuration]
* xref:deploying-to-cloudhub.adoc[Deploy to CloudHub]
* xref:alerts-on-runtime-manager.adoc[Alerts]
