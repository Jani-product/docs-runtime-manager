= CloudHub Custom Log Appender
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:keywords: cloudhub, logging, enhanced log management

image:logo-cloud-active.png[link="/runtime-manager/deployment-strategies", title="CloudHub"]
image:logo-hybrid-disabled.png[link="/runtime-manager/deployment-strategies", title="Hybrid Deployment"]
image:logo-server-disabled.png[link="/runtime-manager/deployment-strategies", title="Anypoint Platform Private Cloud Edition"]
// image:logo-rtf-disabled.png[link="/runtime-manager/deployment-strategies", title="Runtime Fabric"]

You can disable CloudHub logs and integrate with your logging system using the Log4j configuration.


* This feature is only available on request.
+
If you do not have access to this feature, you can request it on the Support portal.
* MuleSoft is not responsible for lost logging data due to misconfiguration of your own Log4j appender.
* MuleSoft is not responsible for misconfigurations that result in performance degradation,
running out of disk space, or other side effects.
* You can use only asynchronous log appenders. Do not use synchronous log appenders.

After you configure logs to flow to both your log system and CloudHub, you disable the default CloudHub application logs. Only the system logs are available. CloudHub continues to warn you that logs in CloudHub are not available. 

For application worker logs, check the logging system for your application. You cannot download logs in this scenario.

== Create Your Log4j Configuration

To have logs flow to both your logging system and be viewable in CloudHub, configure the CloudHub Log4j appender. The Log4j appender sends log data to CloudHub and to a local log file.

To enable the Log4j appender, update the `log4j2.xml` configuration file with your logger settings.

In Anypoint Studio, the `log4j2.xml` file is located in the `src/main/resources` directory.

For details on how to configure `log4j2.xml`, see the
https://logging.apache.org/log4j/2.x/manual/configuration.html[Log4j documentation].

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>
<Configuration status="INFO" name="cloudhub" packages="com.mulesoft.ch.logging.appender">
    <Appenders>
        <RollingFile name="FILE"
                     fileName="/opt/mule/mule-CURRENT/logs/mule-${sys:domain}.log"
                     filePattern="/opt/mule/mule-CURRENT/logs/mule-${sys:domain}-%i.log">

            <PatternLayout pattern="[%d{MM-dd HH:mm:ss.SSS}] %-5p %c{1} [%t]: %m%n"/>
            <DefaultRolloverStrategy max="10"/>
            <Policies>
                <SizeBasedTriggeringPolicy size="10 MB" />
            </Policies>
        </RollingFile>
        <Log4J2CloudhubLogAppender name="CLOUDHUB"
                addressProvider="com.mulesoft.ch.logging.DefaultAggregatorAddressProvider"
                applicationContext="com.mulesoft.ch.logging.DefaultApplicationContext"
                appendRetryIntervalMs="${sys:logging.appendRetryInterval}"
                appendMaxAttempts="${sys:logging.appendMaxAttempts}"
                batchSendIntervalMs="${sys:logging.batchSendInterval}"
                batchMaxRecords="${sys:logging.batchMaxRecords}"
                memBufferMaxSize="${sys:logging.memBufferMaxSize}"
                journalMaxWriteBatchSize="${sys:logging.journalMaxBatchSize}"
                journalMaxFileSize="${sys:logging.journalMaxFileSize}"
                clientMaxPacketSize="${sys:logging.clientMaxPacketSize}"
                clientConnectTimeoutMs="${sys:logging.clientConnectTimeout}"
                clientSocketTimeoutMs="${sys:logging.clientSocketTimeout}"
                serverAddressPollIntervalMs="${sys:logging.serverAddressPollInterval}"
                serverHeartbeatSendIntervalMs="${sys:logging.serverHeartbeatSendIntervalMs}"
                statisticsPrintIntervalMs="${sys:logging.statisticsPrintIntervalMs}">

            <PatternLayout pattern="[%d{MM-dd HH:mm:ss}] %-5p %c{1} [%t]: %m%n"/>
        </Log4J2CloudhubLogAppender>
    </Appenders>
    <Loggers>
        <AsyncRoot level="INFO">
            <AppenderRef ref="FILE"/>
            <AppenderRef ref="CLOUDHUB"/>
        </AsyncRoot>
        <AsyncLogger name="com.gigaspaces" level="ERROR"/>
        <AsyncLogger name="com.j_spaces" level="ERROR"/>
        <AsyncLogger name="com.sun.jini" level="ERROR"/>
        <AsyncLogger name="net.jini" level="ERROR"/>
        <AsyncLogger name="org.apache" level="WARN"/>
        <AsyncLogger name="org.apache.cxf" level="WARN"/>
        <AsyncLogger name="org.springframework.beans.factory" level="WARN"/>
        <AsyncLogger name="org.mule" level="INFO"/>
        <AsyncLogger name="com.mulesoft" level="INFO"/>
        <AsyncLogger name="org.jetel" level="WARN"/>
        <AsyncLogger name="Tracking" level="WARN"/>
    </Loggers>
</Configuration>
----


== Enable Custom Log4j Configurations in CloudHub

Once you configure the Log4j appenders, deploy the application to CloudHub
and disable CloudHub logs:

. From Anypoint Platform, select *Runtime Manager*.
. Click *Applications* in the left menu.
. Click an application to display the details pane:
+
image::chapps.png[CHApps]
+
. Click *Settings* > *Disable CloudHub Logs*.
+
image::disablechlogs.png[DisableCHLogs]
+
The verification prompt appears:
+
image::disablechlogsverification.png[DisableCHLogsVerification]
+
. Click *Apply Changes*.
. Review your application settings to ensure they are correct.
. Click *Apply Changes* to restart your application.

Once your application starts, logs start flowing to your custom Log4j appender and are viewable on your target logging system.

If you did not use the CloudHub Log4j appender specified above, only system logs are available.
System logs provide the status of your worker deployment and whether your application started correctly, but do not provide any application logs.
