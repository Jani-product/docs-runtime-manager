= Install and Configure Runtime Manager Agent
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:keywords: agent, runtime manager, mule, esb, servers, monitor, notifications, external systems, third party, get status, metrics

_Enterprise Edition_

image:logo-cloud-active.png[link="/runtime-manager/deployment-strategies", title="CloudHub"]
image:logo-hybrid-active.png[link="/runtime-manager/deployment-strategies", title="Hybrid Deployment"]
image:logo-server-active.png[link="/runtime-manager/deployment-strategies", title="Anypoint Platform Private Cloud Edition"]
// image:logo-pcf-disabled.png[link="/runtime-manager/deployment-strategies", title="Pivotal Cloud Foundry"]

Runtime Manager agent, which is installed into a Mule runtime engine (Mule), is used to register Mule with Runtime Manager. After Mule is registered, you can manage it with Runtime Manager within the specific environment and Anypoint Platform business group in which it was registered. A Mule can't be registered with multiple Runtime Manager business groups or environments.

If you're deploying your applications to a Pivotal Cloud Foundry environment, you don't need to install or configure Runtime Manager agent. The Pivotal Cloud Foundry build pack automatically creates new runtime instances and agent instances and registers them with Runtime Manager. If you want to change the configuration of your agent instances, you must modify the build pack.


== Compatibility 

The version of Runtime Manager agent must support the version of Runtime Manager you are using. If the required version of the agent is different from the version bundled with Runtime Manager, downgrade the agent to support your version of Anypoint Platform.

The latest version of Mule is bundled with the latest version of Runtime Manager agent. You can download the latest version of Mule from the https://www.mulesoft.com/support-login[Customer Portal].

Mule 3.7.x and earlier and the API gateway version 2.x and earlier include an earlier version of Runtime Manager agent. This earlier version doesn't provide support for exporting data to external analytics tools. If you are running these earlier versions, you can download and upgrade the agent to the latest version.

For the latest version of the agent, see the xref:release-notes::runtime-manager-agent/runtime-manager-agent-release-notes.adoc[Runtime Manager Agent Release Notes].

== Prerequisites

* Your enterprise license is current. 
* You are running Mule 3.6.0 and later, and the API gateway 2.1 and later.

You can download the latest version of Mule Enterprise from the http://www.mulesoft.com/support-login[customer portal].


== Install from a Software Distribution

The agent is bundled with the Mule runtime engine installation.

To install the agent:

. xref:4.2@mule-runtime::runtime-installation-task.adoc[Download and install Mule].
. Run one of these commands:
+
`$MULE_HOME/bin/amc_setup` (Mac and Linux)
+
`$MULE_HOME\bin\amc_setup.bat` (Windows)
+
See <<Installation Options>> for the `amc_setup` arguments.

=== Mule 3.6.0 and 3.6.1 Installation

To install the agent on Mule 3.6.0 or 3.6.1:

. <<Download the Agent,Download the agent>.
. Follow the steps in <<Installing the Agent from the ZIP File,Installing the Agent from the ZIP File>>.
. Run one of these commands:
+
`$MULE_HOME/bin/amc_setup` (Mac and Linux)
+
`$MULE_HOME\bin\amc_setup.bat` (Windows)
+
See <<Installation Options>> for the `amc_setup` arguments.

== Download the Agent 

You can download the latest version of the agent or an earlier version.

=== Download the Latest Version of the Agent

For the latest version of the agent, see xref:release-notes::runtime-manager-agent/runtime-manager-agent-release-notes.adoc[Runtime Manager Agent Release Notes].

To download the latest version of the agent: *(NEED THE EXACT UX HERE)*

. Log in to https://anypoint.mulesoft.com/[Anypoint Platform].
. From the *?* menu, select *Support Center*. 
. From the https://help.mulesoft.com/s/login/[MuleSoft Help Center], click *Downloads*.
. Select *Runtime Manager Agent*. 

=== Download an Earlier Version of the Agent

To download an earlier version of the agent:

. Open the xref:release-notes::runtime-manager-agent/runtime-manager-agent-release-notes.adoc[Runtime Manager Agent Release Notes] for that version.
. 

THIS IS NOT TRUE: Earlier versions of the Release Notes have download links to earlier versions of Runtime Manager agent.

== Install the Agent from the ZIP File

After downloading the Runtime Manager agent ZIP file, determine if you can update an existing Runtime Manager agent installation. 

To determine if heck on the corresponding xref:release-notes::runtime-manager-agent/runtime-manager-agent-release-notes.adoc[Runtime Manager Agent Release Notes].

. Stop Mule or the API gateway runtime.
+
Run the `./mule stop` command or kill the process.
. Extract the `mule-agent-_VERSION_.zip` file to the `$MULE_HOME/bin` folder.
. When prompted, overwrite any conflicting files.
. Run one of these commands:
+
`$MULE_HOME/bin/amc_setup` (Mac and Linux)
+
`$MULE_HOME\bin\amc_setup.bat` (Windows)
+
See <<Installation Options>> for the `amc_setup` arguments.


== Update an Earlier Runtime Manager Agent Installation

You can update an earlier existing Runtime Manager agent installation. To see how to install a new Runtime Manager agent, see the <<Installation Options>> section below.

If an earlier version of Runtime Manager agent is already installed, the `$MULE_HOME/conf` folder includes the `mule_agent.yml` configuration file.

Previous releases of compatible Mule and the API gateway runtimes shipped with an earlier version of the `amc_setup` script. If you installed the agent with an earlier version of this script, you can upgrade the Runtime Manager agent software and retain your existing agent configuration.

For information about starting and stopping the API gateway, see xref:1.x@api-manager::configuring-an-api-gateway.adoc[Configuring an API Gateway].

To upgrade an existing Runtime Manager agent:

. Stop Mule or the API gateway runtime.
+
Run the `./mule stop` command or kill the process.
. Extract the `mule-agent-_VERSION_.zip` file to the `$MULE_HOME/bin` folder.
. When prompted, overwrite any conflicting files.
. Run one of these commands:
+
`$MULE_HOME/bin/amc_setup -U` (Mac and Linux)
+
`$MULE_HOME\bin\amc_setup.bat -U` (Windows)
+
+
This script updates Runtime Manager agent, but does not override the `$MULE_HOME/conf/mule-agent.yml` file.
. Restart Mule:
+
`$MULE_HOME/bin/./mule restart` (Mac and Linux)
`$MULE_HOME\bin\.\mule restart` (Windows)


== Remove a Previous Installation

To uninstall the agent:

. Stop Mule or the API gateway runtime.
+
Run the `./mule stop` command or kill the process.
. Remove these files:
+
** `$MULE_HOME/conf/mule-agent.jks`
** `$MULE_HOME/conf/mule-agent.yml`
. Restart Mule:
+
`$MULE_HOME/bin/./mule restart` (Mac and Linux)
`$MULE_HOME\bin\.\mule restart` (Windows)

=== About the Runtime Manager Agent Update Process

The `amc_setup` script makes the following changes to your Mule runtime engine installation:

. Backs up the current version of the agent:
** Archives everything under `$MULE_HOME/plugins/MULE_AGENT_PLUGIN_FOLDER` to `$MULE_HOME/tools/mule-agent-backup.zip`
** Archives any custom modules you have installed (usually located in `$MULE_HOME/plugins/MULE_AGENT_PLUGIN_FOLDER/lib/modules`) to `$MULE_HOME/tools/mule-agent-modules-backup.zip`.
. Updates agent libs in `$MULE_HOME/plugins/MULE_AGENT_PLUGIN_FOLDER/lib`
. Retains the current `$MULE_HOME/conf/mule-agent.yml` configuration file
. Leaves modules in `$MULE_HOME/plugins/MULE_AGENT_PLUGIN_FOLDER/lib/modules` unchanged
+
This folder contains all custom modules added to the agent that are not included in the agent distribution.

After the process completes, restart the Mule or API gateway instance.

== Installation Options

If you are not updating a previous Runtime Manager agent installation, or if you want to change some of the configuration options, you can run the `amc_setup` command with other options.

To see the available options, run `./amc_setup --help`.

There are three different ways to install and configure a Runtime Manager agent.

* Connect a Runtime Manager agent with an Anypoint Platform Runtime Manager cloud-based console.
* Connect a Runtime Manager agent with an Anypoint Platform Private Cloud Edition Runtime Manager console.
* Connect a Runtime Manager agent with a third party monitoring console.

For each configuration, you use a specific set of options to `amc_setup`.

Communication with either type of Anypoint Runtime Manager console is through WebSockets and is configured as a WebSockets transport in the `$MULE_HOME/conf/mule-agent.yml` file.

Normally, you configure a Runtime Manager agent to communicate and exchange monitoring information with an Anypoint Platform Runtime Manager cloud console. This type of installation is performed using the `-H` option, along with the security token provided by the Anypoint Platform Runtime Manager cloud console. 


=== Editing the Runtime Manager Agent Configuration File

Most of the Runtime Manager agent configuration options add or replace configuration text in the `$MULE_HOME/conf/mule-agent.yml` file. Often you can combine several configuration options into a single `amc_setup` command. You can also add configurations later by re-running `amc_setup` with different (non-conflicting) options. For example, you can configure a Runtime Manager agent to communicate with both a Runtime Manager server and with a third-party console.

Some configuration options are not possible using the `amc_setup` command, such as extending JMX monitoring to other external services. You must manually add them to the `$MULE_HOME/conf/mule-agent.yml` file. You can also back up various configuration options in the `$MULE_HOME/conf/mule-agent.yml` file.


=== Combining Monitoring Console Options

You can configure a Runtime Manager agent to communicate with other management consoles using one or more REST transports. These options are supported by the `-I` and `-S` options.

If you run `amc_setup` with the `-I` or `-S` options, your previous `$MULE_HOME/conf/mule-agent.yml` file is completely replaced.


=== Configuring JMX Monitoring Publication Services

MuleSoft provides several OpenSource JMX monitoring publishing modules for Cloudwatch, Graphite, Nagios, and Zabbix:

* Cloudwatch publishers allows users to send JMX metrics to Amazon Cloudwatch.
* Graphite provides Graphite JMX metrics integration.
* Nagios provides integration with Nagios.
+
This module is included in Mule runtime engine.
* Zabbix sends metrics to Zabbix instances.

For information, see xref:runtime-manager/jmx-service[JMX].

== amc_setup Parameters

Parameters to `amc_setup` support different use cases:

* Register a Mule runtime engine with a Runtime Manager console.
* Manage Mule runtime engine using the local Runtime Manager agent REST API interface, either via HTTP or HTTPS.
* Update the Runtime Manager agent software.
* Get help.

The required arguments differ depending on if you're registering your server to manage using the cloud console of Runtime Manager or using the Anypoint Platform Private Cloud Edition.

The following tables provide details about the parameters you use for these different use cases:

* <<General amc_setup Parameters>>
* <<Hybrid Runtime Manager Management>>
* <<Installation Via Proxy>>


=== General amc_setup Parameters

These arguments work in CloudHub and Anypoint Platform Private Cloud Edition.

[%header,cols="30a,60a"]
|===
|Parameter|Description

|`--help`
|Displays help for the command on the command line.

|`-U`

`--update`
|Updates the agent, preserving existing mule-agent.yml configuration.

|`-E`

`--encrypt`
|Encrypts passwords used in the mule-agent.yml file.


|`--mule-home`
a|Specifies the location of the `$MULE_HOME` directory.

Use this option if you are not running the installation script from `$MULE_HOME/bin`. The mule-agent.yml file is read from `../conf`, relative to this `--mule-home` location.

|`--skip-gateway-clientid`
|Skips configuration of Anypoint API gateway `client_id` and `client_secret`.
|===


=== Hybrid Runtime Manager Management

Configures Runtime Manager agent to create a hybrid management connection with a Runtime Manager. The connection is to a specific environment for a specific business group. The business group can exist in an account in the MuleSoft-managed (cloud-based) Anypoint Platform, or in an Anypoint Platform Private Cloud Edition installation.

The simplest way to manage Mule runtime engine is to register Mule with the MuleSoft-managed Anypoint Platform Runtime Manager console. This option configures Runtime Manager agent to connect to Runtime Manager and requires:

* A valid registration token (provided by the Runtime Manager console)
+
The token applies to a specific environment within a specific business group.
* An instance name.

For details, see xref:managing-servers.adoc#add-a-server[Managing Servers].

The `-H` parameter is required to register a Mule runtime engine with Runtime Manager. 

 The Mule runtime engine will then be managed within this particular Anypoint Platform business group's environment.  The term *hybrid* indicates that the same `-H` parameter is used for both types of Runtime Manager installations: MuleSoft managed (cloud-based) Anypoint Platform accounts, and Anypoint Platform Private Cloud Editions accounts.

In the Runtime Manager console, you can see a full example of the code you need to run by clicking the xref:managing-servers.adoc#add-a-server[Add Server] button. This example command already includes the registration token with you specific organization's ID and the current environment, so it is ready to use in case you don't need to configure anything beyond the default settings.


[%header,cols="20a,80a"]
|===
|Parameter|Description

|`-H <token> <server-name>`

`--hybrid <token> <server-name>`
|Configures Runtime Manager agent to create a hybrid management connection with a Runtime Manager. The connection is to a specific environment for a specific business group in Anypoint Platform. The same command is used for all types of Runtime Manager installations: MuleSoft managed (cloud-based) Anypoint Platform accounts, and Anypoint Platform Private Cloud Editions accounts.

`<token>` is a base64 encoded string that specifies the exact business group and environment with which to register the Mule runtime engine with Runtime Manager. You obtain this token using the *Add Server* button in a Runtime Manager console, and the token is generated by Runtime Manager.

`<server-name>` is the instance name with which to label the Mule runtime engine in the Runtime Manager console. This name must be unique within the business group's environment.

|`-P <PROXY_HOST> <PROXY_PORT> <PROXY_USER> <PROXY_PASSWORD>`

`--proxy <PROXY_HOST> <PROXY_PORT> <PROXY_USER> <PROXY_PASSWORD>`
|Proxy configuration to use when registering with the connection. This option defines proxy details. See <<Installation Via Proxy>>.

|===

==== Obtaining a Registration Token
The `-H` parameter is required to register a Mule runtime engine with Runtime Manager. You must provide a valid registration token to this parameter. The access_token is copied from the Runtime Manager console, for a specific environment within a specific business group. The Mule runtime engine will then be managed within this particular Anypoint Platform business group's environment.  The `-H` is used for both regular (cloud-based) Anypoint Platform and Anypoint Platform Private Cloud Editions.

To obtain the registration token, you need to use the *Add Server* option in Runtime Manager. This presents a complete command to register the Mule runtime engine in the format `./amc_setup -H <token> <server-name>`. After you have the command with the registration token, copy-paste it into the `$MULE_HOME/bin` folder for each Mule runtime engine you wish to register. Make sure to change the instance name `server-name` to the unique instance name you wish to use to label this Mule runtime engine in the Runtime Manager console.

[NOTE]
====
You can use the same copied registration command for multiple Mule runtimes, but make sure to change the default instance name `server-name` to a different and unique instance name for each Mule runtime engine.
====

Here is an example `mule-agent.yml` file generated by the `-H` option:

[source,yaml,linenums]
----
transports:
  rest.agent.transport:
    enabled: false
  websocket.transport:
    consoleUri: wss://mule-manager.anypoint.mulesoft.com:443/mule
    handshake:
      enabled: true
      body:
globalConfiguration:
  security:
    keyStorePassword: 42d9515f-3ca9-4ef4-87c0-586bd786b08b
    keyStoreAlias: agent
    keyStoreAliasPassword: 42d9515f-3ca9-4ef4-87c0-586bd786b08b
  authenticationProxy:
    endpoint: https://arm-auth-proxy.prod.cloudhub.io
----

[WARNING]
====
Do not register a single Mule runtime engine with multiple Runtime Manager business groups or environments.

You can register each individual Mule with Runtime Manager only once.

Do not register a Mule runtime engine with both an older xref:mule-management-console::index.adoc[Mule Management Console (MMC)] and Runtime Manager. If the Mule runtime engine is currently managed in MMC, first unregister the Mule runtime engine with MMC before running the `amc_setup -H` script.
====

[TIP]
====
MuleSoft support can provide you with some migration scripts to help you migrate from MMC to Runtime Manager.

For details, see xref:managing-servers.adoc#add-a-server[Managing Servers].
====

=== Installation Via Proxy

If your Mule runtime engine will run inside a firewall what restricts external communication through a proxy server, you can configure Runtime Manager agent to route REST traffic through the proxy server to Runtime Manager.

To configure the proxy server, pass in the '-P' argument along with the -H argument.

Format: `amc_setup -H <token> <Server Name>  -P <Proxy Host> <Proxy Port> [<Proxy User> <Proxy Password>]`

Where:

* _Proxy Host_ - The host of the desired proxy. You should be able to just specify the hostname. For example you can specify `proxy.acme.com`, not the full URL `+http://proxy.acme.com+` nor `+https://proxy.acme.com+`. If you include `http://` or `https://` in the hostname, you may get an error.
* _Proxy Port_ - The port of the desired proxy.
* _Proxy User_ - (Optional) The user with which to authenticate against the proxy, if the proxy server requires authentication.
* _Proxy Password_ - (Optional) The password with which to authenticate against the proxy, if the proxy server requires authentication.

You can omit _Proxy User_ and _Proxy Password_ if the proxy doesn't require authentication.

Here is an example of configuring Runtime Manager agent with a Runtime Manager token, and also configure a proxy server:


[source,console,linenums]
----
amc_setup -H <token> MaxRuntime -P acme.proxy.com 443
----

Here is an example for a proxy server that requires authentication:


[source,console,linenums]
----
amc_setup -H <token> MaxRuntime -P acme.proxy.com 443 internalAdmin Ins1d3V0icePassword
----

If you have already installed Runtime Manager agent and want to change its configuration to use a proxy, you can do so by editing the `mule-agent.yml` file.

In addition to configuring the proxy server in Runtime Manager agent, you should also configure the proxy server in the `wrapper.conf` file, to also enable API related communication and analytics. For details, see <<Setting up a Proxy>>.


==== Register with an Anypoint Platform Private Cloud Edition Runtime Manager

With Anypoint Platform Private Cloud Edition, all Runtime Manager related services run on-premises rather than in a MuleSoft hosted cloud environment.

The steps to register a Mule runtime engine with an on-premises Runtime Manager are similar to how you register a Mule runtime engine with a MuleSoft managed (cloud-based) Anypoint Platform Runtime Manager, with the following additional final steps:

. Log into an Anypoint Platform Private Cloud Edition account.
. Ensure that you have correctly setup the DNS entry for your platform. See xref:access-management::private-cloud-edition-features.adoc#dns-or-ip[DNS or IP]
. Select a business group and environment to register the Mule runtime engine.
. Within the selected environment, select *Servers* from the left side navigation menu, then click *Add Server*.
. Copy the registration command and paste it into the `$MULE_HOME/bin` folder of the Mule runtime engine you want to register with this Runtime Manager environment. The registration command has the syntax: `./amc_setup -H <token> _server-name_`.
. Replace `_server-name_` with a name for this Mule runtime engine in the Runtime Manager console.
. Add additional parameters to specify the URL of required Anypoint Platform services.
+

The registration command has the same format `./amc_setup -H <token> _server-name_` as the MuleSoft managed Anypoint Platform Runtime Manager, but the registration token will not work in the MuleSoft managed Anypoint Platform. At this point, you need to append some additional parameters to the registration command (after the server name). These parameters specify the URLs for the various services used by Runtime Manager to manage your Mules.

You must supply all the correct values for the registration command parameters to properly register the Mule runtime engine with the on-premises Runtime Manager. All of these parameters are used only to append the `-H` parameter. They are not used with the `-I` or `S` parameters to configure non Runtime Manager REST API connections.

==== Specify URLs of On-Premises Services

This table describes all the additional parameters you need to append to the `./amc_setup -H <token> <server-name>` command to register a Mule runtime engine with an Anypoint Platform Private Cloud Edition Runtime Manager.

[%header,cols="20a,80a"]
|===
|Parameter|Description
|`-A <AMC_HOST>`

`--amc-host <AMC_HOST>`
|Service URL location of your local instance of Runtime Manager, e.g. `+https://10.0.0.1:8080/hybrid/v1+`. You can test if the service is available at `<AMC_HOST>/hybrid/v1`.

|`-W <MCM_HOST>`

`--mcm-host <MCM_HOST>`
|Service URL location of your local instance of MCM, for example `wss://10.0.0.2:443/mule`. You can test if the service is
available at `<MCM_HOST>/mule`.

|`-C <CORE_SERVICES_HOST>`

`--cs-host <CORE_SERVICES_HOST>`
|Service URL of your local instance of Access Management, for example `+https://10.0.0.3:8080/accounts+`.
You can test if the service is available at  `<CORE_SERVICES_HOST>/accounts`.

|`-D <CONTRACT_CACHING_SERVICE_HOST>`

`--contract-caching-service-host <CONTRACT_CACHING_SERVICE_HOST>`
|Service URL location of your local instance of Contract Caching Service, for example: `+https://10.0.0.4:8080+`.


|`-F <API_PLATFORM_HOST>`

`--api-platform-host <API_PLATFORM_HOST>`
|Service URL location of your local instance of API Manager, for example `+https://10.0.0.5:8080/apiplatform+`. I
You can test if the service is available at `<API_PLATFORM_HOST>/apiplatform`.

|`-Z <AUTH_PROXY_SERVICE_HOST>`

`--auth-proxy-host <AUTH_PROXY_SERVICE_HOST>`
|Service URL location of your Auth Proxy, for example: +https://10.0.0.3:8080+.

|===

Full sample command:

[source,console,linenums]
----
./amc_setup -H <token> <server-name> -A +http://$DOCKER_IP_ADDRESS:8080/hybrid/api/v1+ -W "wss://<Anypoint Platform host>:8443/mule" -C https://<AnypointPlatform host>/accounts -F https://<Anypoint Platform host>/apiplatform
----




== Configure the Agent

The sections that follow provide additional configuration details for Runtime Manager agent.

If you want to use Runtime Manager agent to send data from Runtime Manager to Splunk, an ELK stack, or other external software, see xref:sending-data-from-arm-to-external-analytics-software.adoc[Sending Data from Runtime Manager to External Analytics Software].


=== Configure mule-agent.yml

At startup, Runtime Manager agent reads its configuration from the file `$MULE_HOME/conf/mule-agent.yml`.

To configure the agent, manually add, then edit, the configuration parameters in this file:

[source,yaml,linenums]
----
muleInstanceUniqueId: validId
organizationId: organizationId

transports:
    rest.agent.transport:
        security:
            keyStorePassword: rmakeystore.jks
            keyStoreAlias: rma
            keyStoreAliasPassword: mulesoft
        port: 9997

services:
    mule.agent.application.service:
        enabled: true

    mule.agent.domain.service:
        enabled: true

    mule.agent.jmx.publisher.service:
        enabled: true
        frequency: 15
        frequencyTimeUnit: MINUTES
        beans:
            -   beanQueryPattern: java.lang:type=Runtime
                attribute: Uptime
                monitorMessage: Monitoring memory up-time
            -   beanQueryPattern: java.lang:type=MemoryPool,*
                attribute: Usage.used
                monitorMessage" : Used Memory

internalHandlers:
    domaindeploymentnotification.internal.message.handler:
        enabled: false

    applicationdeploymentnotification.internal.message.handler:
        enabled: false
----

==== Configuration File Structure

The `mule-agent.yml` file is structured in three levels:

* First level: Component types: transports, services, internalHandlers, and externalHanders.
** Second level: Component name, for example, `mule.agent.jmx.publisher.service`.
*** Third level: Component configuration. A component can have complex object configurations, including more than one recursive level.

==== Configure Log Location

You can log your Runtime Manager agent state in a separate file from the other Mule log info. For information, see xref:3.8@mule-runtime::logging-in-mule.adoc#configuring-logs-for-runtime-manager-agent[Logging in Mule].

This is only supported in version 1.5.2 or later of Runtime Manager agent.

==== Configure During Runtime

Some agent components allow you to configure them during runtime. For further information, see xref:administration-service.adoc[Administration Service].

== Enable REST Agent Transport and WebSocket Transport

When you register a Mule runtime engine in Runtime Manager, the generated `mule-agent.yml` disables the REST agent transport and replaces any existing configuration.

Conversely, if you run `./amc_setup -I`, you enable the REST agent transport and disable the WebSocket transport (it replaces any existing WebSocket transport configuration used to connect to Runtime Manager).

To run both transports, modify the `mule-agent.yml` file with the following:

[source,yaml,linenums]
----
transports:
  websocket.transport:
    consoleUri: wss://mule-manager.anypoint.mulesoft.com:443/mule
    security:
      keyStorePassword: <password>
      keyStoreAlias: agent
      keyStoreAliasPassword: <password>
      handshake:
        enabled: true
        body:
          agentVersion: 1.1.0
          muleVersion: 3.7.0
          gatewayVersion: 2.0.2
  rest.agent.transport:
    port: 8888

services:
  mule.agent.jmx.publisher.service:
    enabled: true
    frequency: 15
    frequencyTimeUnit: MINUTES
----

== Ports, IP Addresses and Hostnames to Whitelist

In your network, you must whitelist the hostnames and ports of various parts of the Anypoint Platform to allow Runtime Manager agent in a customer-hosted Mule runtime engine to communicate with the MuleSoft-managed online Anypoint Platform APIs and services.

These tables show you the ports or IP addresses/hostnames to add to your whitelists to allow communication between the agent and the Runtime Manager console:

=== Ports

[%header,cols="3*a"]
|===
|Region |Name |Port
|*US*|*anypoint.mulesoft.com* | 443
|*US*|*mule-manager.anypoint.mulesoft.com* | 443
|*US*|*runtime-manager.anypoint.mulesoft.com* | 443
|*US*|*analytics-ingest.anypoint.mulesoft.com* |  443
|*US*|*arm-auth-proxy.prod.cloudhub.io* |  443
|*US*|*data-authenticator.anypoint.mulesoft.com* |  443
|*US*|*exchange2-asset-manager-kprod.s3.amazonaws.com* |  443
|*EU*|*eu1.anypoint.mulesoft.com* | 443
|*EU*|*mule-manager.eu1.anypoint.mulesoft.com* | 443
|*EU*|*runtime-manager.eu1.anypoint.mulesoft.com* | 443
|*EU*|*analytics-ingest.eu1.anypoint.mulesoft.com* |  443
|*EU*|*arm-auth-proxy.prod-eu.msap.io* |  443
|*EU*|*data-authenticator.eu1.anypoint.mulesoft.com* |  443
|*EU*|*exchange2-asset-manager-kprod-eu.s3.eu-central-1.amazonaws.com* |  443
|===

=== Static IP Addresses

<<<<<<< Updated upstream
There are two static IPs that must be whitelisted to access the mule-manager hosts.
=======
To access the mule-manager hosts, whitelist these static IP addresses:
>>>>>>> Stashed changes

[%header,cols="3*a"]
|===
|Region |Name |IP Address
|*US*|*mule-manager.anypoint.mulesoft.com* |52.201.174.72
|*US*|*mule-manager.anypoint.mulesoft.com* |52.201.67.218
|*EU*|*mule-manager.eu1.anypoint.mulesoft.com* |18.195.19.18
|*EU*|*mule-manager.eu1.anypoint.mulesoft.com* |18.194.245.32
|===

The following DNS endpoints do not have static IP addresses:
<<<<<<< Updated upstream

[%header,cols="2*a"]
|====
|Region | Name
|*US*|*runtime-manager.anypoint.mulesoft.com*
|*EU*|*runtime-manager.eu1.anypoint.mulesoft.com*
|====
=======
>>>>>>> Stashed changes

[%header,cols="2*a"]
|====
|Region | Name
|*US*|*runtime-manager.anypoint.mulesoft.com*
|*EU*|*runtime-manager.eu1.anypoint.mulesoft.com*
|====

=== Dynamic IP Addresses

Some of the IP addresses used by Anypoint Platform services are assigned automatically by the underlying cloud infrastructure. Because these are dynamic, do not implement a whitelist based on the specific IP addresses assigned to Anypoint services.

Many firewall devices allow you to define Layer 7 firewall rules so that you can filter by destination name or application type.

Include the following hostnames in your Layer 7 firewall rules:

[%header,cols="2*a"]
|===
|Region |Hostname
|*US*|*anypoint.mulesoft.com*
|*US*|*analytics-ingest.anypoint.mulesoft.com*
|*US*|*arm-auth-proxy.prod.cloudhub.io*
|*US*|*data-authenticator.anypoint.mulesoft.com*
|*EU*|*eu1.anypoint.mulesoft.com*
|*EU*|*analytics-ingest.eu1.anypoint.mulesoft.com*
|*EU*|*arm-auth-proxy.prod-eu.msap.io*
|*EU*|*data-authenticator.eu1.anypoint.mulesoft.com*

|===

== Setting up a Proxy

You can configure Runtime Manager agent to send websocket messages through an HTTP proxy.

Runtime Manager agent only supports the Basic Authentication proxy authentication method.


=== Default wrapper.conf File

Runtime Manager agent reads its proxy configuration from the `$MULE_HOME/conf/wrapper.conf` file, which includes these properties:

* `anypoint.platform.proxy_host`
* `anypoint.platform.proxy_port`
* `anypoint.platform.proxy_username`
* `anypoint.platform.proxy_password`


=== Agent-Specific mule-agent.yml File

To send the insights and monitoring information, Runtime Manager agent calls the auth-proxy service. To connect to this service, the agent reads the proxy configuration from the $MULE_HOME/conf/mule-agent.yml` file:

[source,yaml,linenums]
----
globalConfiguration:
  proxyConfiguration:
    host: "http://exampleHost"
    port: 9999
    user: "exampleUser"
    password: "examplePassword"
----

== Known Issues

[%header,cols="15a,85a"]
|===
|Issue |Description
| SE-8011 | Agent setup returns `407 Proxy Authentication Required` when passing proxy information during setup.
|===

== See Also

* xref:3.8@mule-runtime::installing-an-enterprise-license.adoc[Installing an Enterprise License]
* xref:deploying-to-pcf.adoc[Deploying to Pivotal Cloud Foundry]
* xref:sending-data-from-arm-to-external-analytics-software.adoc[Export Data to External Analytics Tools (Hybrid)]
* xref:1.x@api-manager::configuring-an-api-gateway.adoc[Configuring an API Gateway]
* xref:runtime-manager-agent-architecture.adoc[Runtime Manager Agent Architecture]
* xref:event-tracking.adoc[Event Tracking]
